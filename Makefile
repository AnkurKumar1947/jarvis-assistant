# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ                    ๐ค JARVIS ASSISTANT                        โ
# โ                        Makefile                               โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

.PHONY: all install dev start stop server web clean help voices

# Default target
all: dev

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Installation
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

install: ## Install all dependencies
	@echo "๐ฆ Installing server dependencies..."
	@cd apps/server && npm install
	@echo "๐ฆ Installing web dependencies..."
	@cd apps/web && npm install
	@echo "โ All dependencies installed!"

install-server: ## Install server dependencies only
	@cd apps/server && npm install

install-web: ## Install web dependencies only
	@cd apps/web && npm install

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Development
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

dev: ## Start both server and web in development mode
	@./start.sh

start: dev ## Alias for dev

server: ## Start backend server only
	@./start.sh -s

web: ## Start web frontend only
	@./start.sh -w

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Production Build
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

build: ## Build both server and web for production
	@echo "๐๏ธ Building server..."
	@cd apps/server && npm run build
	@echo "๐๏ธ Building web..."
	@cd apps/web && npm run build
	@echo "โ Production build complete!"

build-server: ## Build server only
	@cd apps/server && npm run build

build-web: ## Build web only
	@cd apps/web && npm run build

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Utilities
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

stop: ## Stop all running Jarvis processes
	@echo "๐ Stopping Jarvis..."
	@-lsof -ti :3000 | xargs kill -9 2>/dev/null || true
	@-lsof -ti :3001 | xargs kill -9 2>/dev/null || true
	@echo "โ All processes stopped"

restart: stop dev ## Restart all services

clean: ## Clean node_modules and build artifacts
	@echo "๐งน Cleaning..."
	@rm -rf apps/server/node_modules apps/server/dist
	@rm -rf apps/web/node_modules apps/web/.next apps/web/out
	@echo "โ Cleaned!"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Voice Models
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

voices: ## Download Piper voice models
	@echo "๐๏ธ Downloading voice models..."
	@cd apps/server && ./scripts/download-piper-voices.sh

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Checks
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

check: ## Check system requirements
	@echo "๐ Checking requirements..."
	@echo ""
	@echo "Node.js: $$(node -v 2>/dev/null || echo 'NOT FOUND')"
	@echo "npm:     v$$(npm -v 2>/dev/null || echo 'NOT FOUND')"
	@echo "sox:     $$(sox --version 2>/dev/null | head -1 || echo 'NOT FOUND (optional)')"
	@echo "piper:   $$(piper --version 2>/dev/null || echo 'NOT FOUND (optional)')"
	@echo "ollama:  $$(ollama --version 2>/dev/null || echo 'NOT FOUND (optional)')"
	@echo ""

status: ## Show status of running services
	@echo "๐ Service Status:"
	@echo ""
	@if lsof -i :3001 > /dev/null 2>&1; then \
		echo "  Backend (3001):  ๐ข Running"; \
	else \
		echo "  Backend (3001):  ๐ด Stopped"; \
	fi
	@if lsof -i :3000 > /dev/null 2>&1; then \
		echo "  Frontend (3000): ๐ข Running"; \
	else \
		echo "  Frontend (3000): ๐ด Stopped"; \
	fi
	@if lsof -i :11434 > /dev/null 2>&1; then \
		echo "  Ollama (11434):  ๐ข Running"; \
	else \
		echo "  Ollama (11434):  ๐ด Stopped"; \
	fi
	@echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Help
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

help: ## Show this help message
	@echo ""
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo "โ                    ๐ค JARVIS ASSISTANT                        โ"
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ"
	@echo "โ  Usage: make [target]                                        โ"
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'
	@echo ""
